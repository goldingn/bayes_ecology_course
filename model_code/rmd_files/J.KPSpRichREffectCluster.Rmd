```{r packages}
library(jagsUI)
```

```{r model}
modfile <- tempfile()
writeLines("
model
{
  mlogarea <- mean(logarea[])   # means of explanatory variables
  mvwall <- mean(vwall[])
  memerg <- mean(emerg[])
  msubmerg <- mean(submerg[])
  mfring <- mean(fring[])
	
  a ~ dnorm(0, 1.0E-6)  # prior for intercept term
	
  for(j in 1:5) {
    b[j] ~ dnorm(0, 1.0E-6)     # prior for regression coefficients
  }

  sd_cluster ~ dunif(0, 100)    # prior for sd of variation among clusters
  prec_cluster <- 1 / sd_cluster / sd_cluster   # sd converted to precision

  # for each of the 26 clusters
  for(i in 1:26) {
    recluster[i] ~ dnorm(0, prec_cluster)   # generate random cluster effects
  }

 # for each of the 104 ponds
  for(i in 1:104) {
    nlogarea[i] <- logarea[i] - mlogarea   # calculate the centred explanatory variables
    nvwall[i] <- vwall[i] - mvwall
    nemerg[i] <- emerg[i] - memerg
    nsubmerg[i] <- submerg[i] - msubmerg
    nfring[i] <- fring[i] - mfring
	
	  # calculated expected species richness, including random effect of cluster
    m[i] <- exp(a + b[1] * nlogarea[i] + b[2] * nvwall[i] + b[3] * nemerg[i] + b[4] * nsubmerg[i] + b[5] * nfring[i] + recluster[cluster[i]])  
    SR[i] ~ dpois(m[i])
  }

  # predictions versus submergent vegetation
  for(i in 1:20) {
    pred_sub[i] <- exp(a + b[4] * (5 * (i - 1) - msubmerg))
  }

  # predictions versus area
  for(i in 1:25) {
    pred_area[i] <- exp(a + b[1] * (0.2 * i - mvwall))   
  }
}
           ", con = modfile)
```

```{r data}
data <- list(
  cluster = c(1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 
              3, 3, 3, 3, 3, 4, 4, 5, 5, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 
              7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 
              8, 8, 8, 8, 8, 8, 8, 9, 10, 10, 10, 11, 12, 12, 13, 14, 14, 15, 
              15, 15, 15, 15, 16, 17, 18, 19, 19, 20, 20, 21, 22, 23, 23, 23, 
              23, 23, 23, 23, 23, 23, 23, 23, 23, 24, 24, 25, 26),
  logarea = c(3.870111155, 
              3.326949994, 2.85672889, 1.62324929, 4.629684769, 0.698970004, 
              2.155336037, 1.886490725, 3.100715087, 2.494154594, 3.177247836, 
              3.314499228, 2.257678575, 1.531478917, 1.397940009, 1.041392685, 
              2.089905111, 1.361727836, 0.301029996, 0.698970004, 3.750816843, 
              2.399673721, 1.986771734, 3.324693914, 3.044931546, 3.377488383, 
              1.591064607, 2.330413773, 1.447158031, 3.103461622, 2.699837726, 
              3.832955751, 2.687528961, 2.769377326, 2.707570176, 2.482873584, 
              3.671635597, 4.017283822, 3.409595019, 3.1752218, 3.679246145, 
              2.598790507, 2.298853076, 4.100852827, 3.137354111, 2.928395852, 
              3.122543524, 2.338456494, 3.557386882, 3.293583513, 2.440909082, 
              3.515211304, 3.592287816, 1.716003344, 2.181843588, 2.95568775, 
              1.462397998, 2.225309282, 2.103803721, 2.344392274, 1.462397998, 
              1.414973348, 1.698970004, 3.087426457, 2.911157609, 4.412913926, 
              4.087745935, 2.515873844, 2.797959644, 4.708454894, 3.508260306, 
              3.678062905, 3.363423933, 4.398061594, 4.909764569, 4.286209386, 
              4.529212126, 2.240549248, 3.812512284, 3.047274867, 4.174205227, 
              4.097465554, 2.788875116, 2.82672252, 3.750662646, 3.003891166, 
              3.913442955, 1.204119983, 0.477121255, 1.477121255, 1.041392685, 
              0.903089987, 1.113943352, 0.77815125, 0.84509804, 0.77815125, 
              2.155336037, 1.255272505, 1.176091259, 1.462397998, 4.690869158, 
              3.599227863, 2.318063335, 3.671543085),
  vwall = c(0, 1, 1, 1, 
            1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 
            1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
            0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 
            1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 
            1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0),
  emerg = c(0, 
            5, 20, 60, 1, 20, 1, 1, 8, 50, 20, 10, 30, 95, 95, 25, 60, 90, 
            50, 50, 5, 50, 5, 15, 5, 5, 0, 0, 1, 10, 60, 50, 35, 10, 60, 
            15, 15, 10, 25, 70, 5, 30, 35, 20, 60, 97, 80, 15, 40, 5, 40, 
            5, 100, 5, 40, 15, 0, 25, 20, 25, 1, 0, 0, 60, 85, 40, 35, 15, 
            5, 6, 90, 5, 1, 90, 5, 40, 50, 10, 20, 0, 0, 10, 20, 20, 2, 25, 
            15, 0, 0, 1, 25, 5, 15, 30, 20, 0, 0, 0, 10, 15, 3, 2, 20, 1), 
  submerg = c(0, 2, 0, 0, 0, 70, 0, 8, 2, 0, 20, 5, 30, 15, 
              10, 0, 30, 0, 20, 20, 0, 0, 1, 0, 0, 0, 0, 0, 0, 5, 5, 20, 
              50, 70, 25, 70, 5, 5, 5, 10, 1, 25, 50, 30, 20, 2, 5, 5, 
              15, 1, 20, 1, 0, 30, 20, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 5, 
              5, 0, 0, 4, 0, 1, 1, 10, 60, 30, 15, 0, 60, 40, 0, 5, 10, 
              5, 0, 10, 5, 0, 0, 0, 0, 0, 0, 60, 0, 20, 0, 0, 0, 50, 20, 
              90, 5, 0),
  fring = c(50, 100, 100, 85, 30, 0, 25, 0, 30, 
            50, 30, 30, 80, 90, 30, 60, 10, 2, 90, 90, 5, 80, 0, 30, 
            15, 0, 0, 0, 30, 60, 100, 100, 95, 100, 100, 80, 100, 100, 
            100, 60, 100, 80, 100, 100, 100, 100, 100, 60, 100, 10, 80, 
            50, 100, 70, 40, 35, 0, 5, 100, 90, 100, 0, 0, 55, 15, 100, 
            100, 60, 70, 99, 90, 90, 50, 50, 100, 100, 100, 40, 100, 
            0, 0, 80, 25, 25, 20, 25, 55, 0, 70, 20, 10, 0, 65, 0, 10, 
            50, 0, 75, 40, 20, 98, 98, 100, 15),
  SR = c(1, 1, 1, 1, 1, 
         0, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 
         1, 1, 1, 0, 0, 7, 6, 6, 4, 3, 7, 6, 5, 5, 8, 5, 6, 6, 7, 
         6, 2, 1, 6, 3, 3, 4, 5, 2, 4, 0, 1, 1, 0, 1, 1, 1, 1, 0, 
         0, 1, 2, 4, 3, 1, 1, 4, 1, 1, 4, 5, 3, 2, 2, 2, 2, 0, 0, 
         3, 1, 1, 1, 5, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 
         1, 1, 2, 1)
)
```

```{r inits}
inits <- function () {
  list(a = 0, b = c(0, 0, 0, 0, 0), sd_cluster = 1)
}
```

```{r params}
params <- c("a", "b", "sd_cluster")
```

```{r fit}
fit <- autojags(data, inits, params, modfile, n.chains = 4)
```

```{r plot}
plot(fit)
summary(fit$samples)
```


